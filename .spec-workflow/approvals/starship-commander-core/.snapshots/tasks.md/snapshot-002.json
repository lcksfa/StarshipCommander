{
  "id": "snapshot_1766399414867_lxhopjdkc",
  "approvalId": "approval_1766399179789_agwhhl2n3",
  "approvalTitle": "Starship Commander 任务文档（含可视化验收标准）",
  "version": 2,
  "timestamp": "2025-12-22T10:30:14.867Z",
  "trigger": "approved",
  "status": "pending",
  "content": "# Starship Commander 实施任务文档 - 优先任务模块\n\n## 阶段一：后端核心服务开发\n\n### 数据库和类型定义 (优先级：高)\n\n- [ ] 1. 更新 Prisma 数据库模式\n  - 文件: prisma/schema.prisma\n  - 任务：添加任务分类枚举 (BODY, BRAIN, BASE)，完善 Mission 模型，添加 MissionHistory 历史记录表\n  - 目的：支持前端任务系统和历史记录功能\n  - _复用现有：当前 Prisma 配置，前端 Mission 接口_\n  - _需求关联：任务系统、历史记录_\n  - _提示：实施任务 starship-commander-core，先运行 spec-workflow-guide 获取工作流指南再实施。角色: Prisma 数据库专家 | 任务：扩展数据库模式以支持任务分类和多语言标题，添加历史记录表用于 CaptainsLog 组件 | 限制：保持现有数据结构兼容，确保外键关系正确_\n  \n  **🔍 可视化验收标准:**\n  - **测试1**: 运行 `pnpm prisma:generate` 成功生成客户端代码\n  - **测试2**: 运行 `pnpm prisma:push` 成功应用模式更改\n  - **测试3**: 在 Prisma Studio 中可以看到新增的 Category 枚举和 MissionHistory 表\n  - **测试4**: 创建测试数据验证多语言 JSON 字段存储格式正确\n\n- [ ] 2. 创建前后端共享类型定义\n  - 文件: src/shared/types.ts\n  - 任务：定义 Mission, UserStats, Category, LocalizedString 接口\n  - 目的：确保前后端类型完全一致\n  - _复用现有：前端类型定义 src/frontend/types.ts_\n  - _需求关联：类型安全_\n  - _提示：实施任务 starship-commander-core，先运行 spec-workflow-guide 获取工作流指南再实施。角色: TypeScript 类型专家 | 任务：创建共享类型定义，确保 Mission 接口与前端完全匹配，支持多语言和任务分类 | 限制：类型定义必须与前端 100% 匹配，不破坏现有代码_\n  \n  **🔍 可视化验收标准:**\n  - **测试1**: 运行 `pnpm typecheck` 无类型错误\n  - **测试2**: 在 VS Code 中可以看到前后端共享相同的 Mission 接口定义\n  - **测试3**: 创建测试对象验证所有属性类型匹配\n  - **测试4**: 确保 Category 枚举值与前端组件完全对应\n\n### 任务服务开发 (优先级：高)\n\n- [ ] 3. 实现 Mission 服务\n  - 文件: src/backend/modules/mission/mission.service.ts\n  - 任务：扩展现有服务，添加 getMissions、completeMission、createMission 方法\n  - 目的：提供任务管理的核心业务逻辑\n  - _复用现有：当前 Mission 模块结构，Prisma 客户端_\n  - _需求关联：任务系统核心功能_\n  - _提示：实施任务 starship-commander-core，先运行 spec-workflow-guide 获取工作流指南再实施。角色: NestJS 后端开发工程师 | 任务：扩展任务服务以支持任务列表查询（按分类筛选）、任务完成逻辑（奖励计算）、用户自定义任务创建 | 限制：必须保持现有功能，确保数据一致性，处理所有边界情况_\n  \n  **🔍 可视化验收标准:**\n  - **测试1**: 运行后端服务，Postman 测试 getMissions 接口返回正确格式的任务列表\n  - **测试2**: 测试任务分类筛选功能 (BODY, BRAIN, BASE) 工作正常\n  - **测试3**: 测试 completeMission 方法返回正确的 XP 和 CR 奖励数据\n  - **测试4**: 在数据库中验证任务完成状态和历史记录正确更新\n\n- [ ] 4. 实现 Mission tRPC 路由器\n  - 文件: src/backend/modules/mission/mission.router.ts\n  - 任务：创建任务相关的 tRPC 路由，包括输入验证\n  - 目的：为前端提供类型安全的任务 API\n  - _复用现有：当前 tRPC 配置，Zod 验证库_\n  - _需求关联：任务 API 接口_\n  - _提示：实施任务 starship-commander-core，先运行 spec-workflow-guide 获取工作流指南再实施。角色: tRPC API 开发专家 | 任务：创建任务 tRPC 路由器，实现 getMissions（支持分类筛选）、completeMission（返回奖励）、createMission（用户创建）端点 | 限制：必须使用 Zod 进行输入验证，保持现有路由结构，确保类型安全_\n  \n  **🔍 可视化验收标准:**\n  - **测试1**: 在浏览器中访问 `/trpc/mission.getMissions` 端点看到正确的任务列表\n  - **测试2**: 测试无效输入时返回 Zod 验证错误\n  - **测试3**: 测试任务完成 API 返回包含 XP 和 CR 的奖励对象\n  - **测试4**: 在 Swagger 文档中可以看到完整的 tRPC 路由定义\n\n### 历史记录服务开发 (优先级：高)\n\n- [ ] 5. 实现 MissionHistory 服务\n  - 文件: src/backend/modules/history/history.service.ts\n  - 目的：管理任务完成历史记录，支持 CaptainsLog 组件\n  - 任务：创建历史记录服务，处理任务完成事件记录\n  - _复用现有：Prisma 客户端，现有服务模式_\n  - _需求关联：历史记录功能_\n  - _提示：实施任务 starship-commander-core，先运行 spec-workflow-guide 获取工作流指南再实施。角色: NestJS 服务开发工程师 | 任务：创建历史记录服务，在任务完成时自动记录，支持按时间和分类查询，处理多语言标题存储 | 限制：确保与任务完成流程集成，处理数据量增长，保持查询性能_\n  \n  **🔍 可视化验收标准:**\n  - **测试1**: 完成任务后在数据库中看到新的历史记录\n  - **测试2**: 测试历史记录查询接口按时间倒序返回数据\n  - **测试3**: 验证多语言标题在历史记录中正确存储\n  - **测试4**: 测试分页查询功能在大数据量下性能正常\n\n- [ ] 6. 实现 MissionHistory tRPC 路由器\n  - 文件: src/backend/modules/history/history.router.ts\n  - 任务：创建历史记录查询的 tRPC 路由\n  - 目的：为 CaptainsLog 组件提供历史数据 API\n  - _复用现有：tRPC 模式，历史记录服务_\n  - _需求关联：历史记录 API_\n  - _提示：实施任务 starship-commander-core，先运行 spec-workflow-guide 获取工作流指南再实施。角色: tRPC 查询接口专家 | 任务：创建历史记录路由器，实现 getHistory（支持分页和筛选）端点，优化查询性能 | 限制：必须支持分页查询，处理大量历史数据，保持响应速度_\n  \n  **🔍 可视化验收标准:**\n  - **测试1**: 测试 `/trpc/history.getHistory` 端点返回格式正确的历史记录\n  - **测试2**: 验证分页参数 (limit, offset) 工作正常\n  - **测试3**: 测试按任务分类筛选历史记录功能\n  - **测试4**: 确保查询响应时间在可接受范围内 (< 300ms)\n\n## 阶段二：前后端联调任务\n\n### 前端 API 集成 (优先级：高)\n\n- [ ] 7. 配置前端 tRPC 客户端\n  - 文件: src/frontend/lib/trpc.ts\n  - 任务：设置 tRPC 客户端，连接后端路由器\n  - 目的：建立前后端类型安全的通信桥梁\n  - _复用现有：前端 React 配置，tRPC 客户端库_\n  - _需求关联：前后端通信_\n  - _提示：实施任务 starship-commander-core，先运行 spec-workflow-guide 获取工作流指南再实施。角色: React 集成开发专家 | 任务：配置 tRPC 客户端以连接新的任务和历史记录路由器，设置 React Query 用于数据缓存和状态管理 | 限制：必须保持类型安全，处理网络错误，提供良好的用户体验_\n  \n  **🔍 可视化验收标准:**\n  - **测试1**: 在浏览器开发者工具中可以看到成功的 tRPC 请求\n  - **测试2**: 测试网络错误时显示友好的错误提示\n  - **测试3**: 验证 React Query 缓存功能正常工作\n  - **测试4**: 确保前后端类型检查通过，无类型错误\n\n- [ ] 8. 更新 MissionCard 组件集成真实 API\n  - 文件: src/frontend/components/MissionCard.tsx\n  - 任务：替换模拟数据，集成真实的任务完成 API\n  - 目的：让任务卡片能够调用真实的后端服务\n  - _复用现有：现有 MissionCard 组件，新的 tRPC 客户端_\n  - _需求关联：任务执行功能_\n  - _提示：实施任务 starship-commander-core，先运行 spec-workflow-guide 获取工作流指南再实施。角色: React 组件开发工程师 | 任务：修改 MissionCard 组件以使用真实的任务完成 API，处理加载状态，显示真实奖励，集成成功弹窗 | 限制：必须保持现有 UI/UX，处理 API 错误，提供即时反馈_\n  \n  **🔍 可视化验收标准:**\n  - **测试1**: 点击任务卡片的\"Engage\"按钮显示加载状态\n  - **测试2**: 任务完成后显示正确的 XP 和 CR 奖励\n  - **测试3**: 成功弹窗动画正常触发并显示真实奖励数据\n  - **测试4**: 任务状态在完成后正确更新为已完成状态\n\n- [ ] 9. 更新 CaptainsLog 组件集成历史记录 API\n  - 文件: src/frontend/components/CaptainsLog.tsx\n  - 任务：集成历史记录查询 API，显示真实任务历史\n  - 目的：让船长日志显示真实的任务完成记录\n  - _复用现有：现有 CaptainsLog 组件，历史记录路由器_\n  - _需求关联：历史记录显示_\n  - _提示：实施任务 starship-commander-core，先运行 spec-workflow-guide 获取工作流指南再实施。角色: React 数据展示专家 | 任务：修改 CaptainsLog 组件以查询真实的历史记录数据，支持分页加载，按分类筛选，显示多语言标题 | 限制：必须保持现有设计，处理分页逻辑，支持大数据量显示_\n  \n  **🔍 可视化验收标准:**\n  - **测试1**: CaptainsLog 显示真实的任务完成历史记录\n  - **测试2**: 滚动加载更多历史记录功能正常工作\n  - **测试3**: 按任务分类筛选功能正常工作\n  - **测试4**: 多语言标题根据用户语言设置正确显示\n\n- [ ] 10. 更新 App 组件状态管理\n  - 文件: src/frontend/App.tsx\n  - 任务：将全局状态从模拟数据迁移到真实 API\n  - 目的：让整个应用使用真实的后端数据\n  - _复用现有：现有 App 组件，tRPC Query hooks_\n  - _需求关联：全局数据管理_\n  - _提示：实施任务 starship-commander-core，先运行 spec-workflow-guide 获取工作流指南再实施。角色: React 状态管理专家 | 任务：更新 App 组件，使用 tRPC Query hooks 替换模拟数据，实现全局状态同步，处理加载和错误状态 | 限制：必须保持现有 UI/UX，确保数据同步正确，处理离线场景_\n  \n  **🔍 可视化验收标准:**\n  - **测试1**: 应用启动时显示真实的用户统计数据\n  - **测试2**: 任务列表显示来自后端的真实数据\n  - **测试3**: 完成任务后所有相关数据实时更新\n  - **测试4**: 页面刷新后数据状态保持一致\n\n## 阶段三：测试和优化\n\n### 功能测试 (优先级：中)\n\n- [ ] 11. 任务完成流程测试\n  - 任务：端到端测试任务创建、执行、完成的完整流程\n  - 目的：验证任务系统功能完整性\n  - _复用现有：前端测试环境，后端测试数据库_\n  - _需求关联：功能验证_\n  - _提示：实施任务 starship-commander-core，先运行 spec-workflow-guide 获取工作流指南再实施。角色: 全栈测试工程师 | 任务：创建端到端测试用例，验证任务完成后的数据更新、奖励计算、历史记录创建等完整流程 | 限制：必须测试所有任务分类，验证边界情况，确保数据一致性_\n  \n  **🔍 可视化验收标准:**\n  - **测试1**: 录制用户完成任务的完整操作视频\n  - **测试2**: 使用 Cypress 或 Playwright 自动化测试验证整个流程\n  - **测试3**: 在测试报告中显示所有测试用例通过状态\n  - **测试4**: 验证数据库中的最终状态与预期一致\n\n- [ ] 12. 前后端数据一致性测试\n  - 任务：验证前后端数据结构完全匹配\n  - 目的：确保类型安全和数据同步\n  - _复用现有：类型检查工具，API 测试框架_\n  - _需求关联：数据一致性_\n  - _提示：实施任务 starship-commander-core，先运行 spec-workflow-guide 获取工作流指南再实施。角色: 数据一致性验证专家 | 任务：测试前后端接口数据格式，验证类型定义，测试边界数据，确保零数据丢失 | 限制：必须覆盖所有数据字段，测试特殊字符和多语言内容_\n  \n  **🔍 可视化验收标准:**\n  - **测试1**: 创建对比工具显示前后端数据结构差异\n  - **测试2**: 运行类型检查显示 0 错误\n  - **测试3**: 测试特殊字符和表情符号正确传输\n  - **测试4**: 多语言内容在前后端显示完全一致\n\n### 性能优化 (优先级：中)\n\n- [ ] 13. 任务查询性能优化\n  - 任务：优化任务列表查询性能\n  - 目的：确保大量任务时响应速度\n  - _复用现有：数据库查询优化工具_\n  - _需求关联：性能要求_\n  - _提示：实施任务 starship-commander-core，先运行 spec-workflow-guide 获取工作流指南再实施。角色: 数据库性能优化专家 | 任务：优化任务查询 SQL，添加必要索引，优化数据传输格式，实现查询缓存 | 限制：必须保持数据准确性，不能通过缓存获得过期数据_\n  \n  **🔍 可视化验收标准:**\n  - **测试1**: 使用浏览器开发工具测量 API 响应时间 (< 200ms)\n  - **测试2**: 创建 1000+ 测试任务验证查询性能\n  - **测试3**: 使用数据库分析工具显示查询执行计划优化\n  - **测试4**: 缓存命中率监控显示 > 80%\n\n- [ ] 14. 历史记录查询优化\n  - 任务：优化历史记录查询性能\n  - 目的：支持大量历史数据的快速查询\n  - _复用现有：分页查询技术_\n  - _需求关联：历史记录性能_\n  - _提示：实施任务 starship-commander-core，先运行 spec-workflow-guide 获取工作流指南再实施。角色: 查询性能专家 | 任务：实现历史记录分页查询优化，添加复合索引，实现查询结果缓存，优化前端渲染性能 | 限制：必须保持数据完整性，确保分页逻辑正确_\n  \n  **🔍 可视化验收标准:**\n  - **测试1**: 历史记录分页加载响应时间 < 300ms\n  - **测试2**: 创建 10000+ 历史记录验证查询性能\n  - **测试3**: 监控 CaptainsLog 组件滚动性能 (60 FPS)\n  - **测试4**: 数据库查询优化报告显示性能提升",
  "fileStats": {
    "size": 14112,
    "lines": 211,
    "lastModified": "2025-12-22T10:26:09.909Z"
  },
  "comments": []
}