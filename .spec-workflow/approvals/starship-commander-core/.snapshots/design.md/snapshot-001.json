{
  "id": "snapshot_1766394818728_5gwxg6tt3",
  "approvalId": "approval_1766394818721_kh1cizohf",
  "approvalTitle": "Starship Commander 核心功能技术设计文档",
  "version": 1,
  "timestamp": "2025-12-22T09:13:38.728Z",
  "trigger": "initial",
  "status": "pending",
  "content": "# Design Document - Starship Commander Core\n\n## Overview\n\nStarship Commander 核心功能设计基于现有的 NestJS + tRPC + React 技术栈，采用全栈 TypeScript 架构。本设计将现有原型系统重构为生产就绪的沉浸式科幻任务管理应用，实现舰桥控制台、任务系统、结算奖励和数据同步等核心功能。\n\n设计重点是将当前的前端原型与后端架构有机结合，创建类型安全、高性能、可扩展的游戏化体验系统。\n\n## Steering Document Alignment\n\n### Technical Standards\n- **全栈 TypeScript**: 确保类型安全和开发体验一致性\n- **模块化架构**: 遵循 NestJS 的模块化设计模式\n- **tRPC 类型安全**: 前后端 API 调用完全类型安全\n- **React 19**: 利用最新的 React 特性和性能优化\n- **Prisma ORM**: 类型安全的数据库访问和迁移\n\n### Project Structure\n```\nsrc/\n├── frontend/          # React 前端应用\n│   ├── components/    # 可复用 UI 组件\n│   ├── contexts/      # React Context 状态管理\n│   ├── hooks/         # 自定义 React Hooks\n│   ├── services/      # API 服务层\n│   └── types/         # TypeScript 类型定义\n├── backend/           # NestJS 后端应用\n│   ├── modules/       # 业务模块\n│   ├── services/      # 业务服务\n│   ├── utils/         # 工具函数\n│   └── trpc/          # tRPC 路由和配置\n└── shared/            # 共享类型和工具\n    ├── types/         # 共享类型定义\n    └── constants/     # 共享常量\n```\n\n## Code Reuse Analysis\n\n### Existing Components to Leverage\n- **HUD Component**: 现有的舰桥控制台组件，需要增强状态展示和动画效果\n- **MissionCard Component**: 任务卡片组件，需要添加任务状态管理和冷却机制\n- **SuccessOverlay Component**: 结算弹窗组件，需要增强动画效果和数据反馈\n- **StarBackground Component**: 星空背景组件，可以直接复用\n- **Hologram Component**: 全息效果组件，用于增强科幻氛围\n\n### Backend Architecture to Extend\n- **tRPC Service**: 现有的 tRPC 配置，需要添加任务、用户统计等路由\n- **Mission Module**: 任务管理模块，需要完善业务逻辑和数据持久化\n- **Prisma Schema**: 数据库模式，需要适配新的需求并优化关系设计\n\n### Integration Points\n- **Database Layer**: Prisma ORM 连接 SQLite 数据库，支持多语言内容存储\n- **API Layer**: tRPC 提供类型安全的 API 接口\n- **State Management**: React Context + tRPC Query 实现状态同步\n- **Real-time Updates**: 可扩展 WebSocket 支持实时数据更新\n\n## Architecture\n\n### 整体架构设计\n\n```mermaid\ngraph TB\n    subgraph \"Frontend (React 19)\"\n        A[HUD Dashboard] --> B[Mission System]\n        B --> C[Reward System]\n        C --> D[User Profile]\n        E[Language Context] --> A\n        E --> B\n        E --> C\n        E --> D\n    end\n    \n    subgraph \"API Layer (tRPC)\"\n        F[tRPC Router] --> G[Mission Router]\n        F --> H[User Stats Router]\n        F --> I[Achievement Router]\n        F --> J[Sync Router]\n    end\n    \n    subgraph \"Backend (NestJS)\"\n        G --> K[Mission Service]\n        H --> L[User Service]\n        I --> M[Achievement Service]\n        J --> N[Sync Service]\n    end\n    \n    subgraph \"Data Layer\"\n        K --> O[Prisma ORM]\n        L --> O\n        M --> O\n        N --> O\n        O --> P[SQLite Database]\n    end\n    \n    A -.-> F\n    B -.-> G\n    C -.-> H\n    D -.-> I\n```\n\n### 模块化设计原则\n\n#### 前端模块化\n- **单一文件职责**: 每个组件文件专注于单一功能领域\n- **组件隔离**: 创建小型、专注的组件而非大型单体文件\n- **服务层分离**: 分离数据访问、业务逻辑和表现层\n- **工具模块化**: 将工具函数分解为专注的单一目的模块\n\n#### 后端模块化\n- **模块独立性**: 每个业务模块独立，具有清晰的边界\n- **依赖注入**: 使用 NestJS 的 DI 容器管理依赖关系\n- **接口抽象**: 定义清晰的接口契约，便于测试和维护\n- **错误处理**: 统一的错误处理和响应格式\n\n## Components and Interfaces\n\n### Frontend Components\n\n#### 1. EnhancedHUD Component\n- **Purpose:** 增强型舰桥控制台，显示用户状态、进度条和动态效果\n- **Interfaces:** \n  ```typescript\n  interface HUDProps {\n    stats: UserStats;\n    compact?: boolean;\n    showAnimations?: boolean;\n  }\n  \n  interface UserStats {\n    level: number;\n    currentXp: number;\n    maxXp: number;\n    coins: number;\n    totalMissionsCompleted: number;\n    rank: string;\n  }\n  ```\n- **Dependencies:** React Context, Animation Library, tRPC Query\n- **Reuses:** 现有 HUD 组件结构和样式\n\n#### 2. MissionSystem Component\n- **Purpose:** 任务系统管理，包含任务分类、状态管理和执行交互\n- **Interfaces:**\n  ```typescript\n  interface MissionSystemProps {\n    missions: Mission[];\n    onCompleteMission: (missionId: string) => void;\n    category?: MissionCategory;\n  }\n  \n  interface Mission {\n    id: string;\n    title: LocalizedString;\n    description: LocalizedString;\n    category: MissionCategory;\n    xpReward: number;\n    coinReward: number;\n    isCompleted: boolean;\n    cooldownUntil?: Date;\n  }\n  ```\n- **Dependencies:** MissionCard, Timer Component, tRPC Mutation\n- **Reuses:** 现有 MissionCard 组件，添加冷却和状态管理\n\n#### 3. RewardOverlay Component\n- **Purpose:** 任务完成结算界面，显示\"Mission Accomplished\"动画和奖励\n- **Interfaces:**\n  ```typescript\n  interface RewardOverlayProps {\n    isOpen: boolean;\n    xp: number;\n    coins: number;\n    onClose: () => void;\n    showLevelUp?: boolean;\n  }\n  ```\n- **Dependencies:** Animation Library, Sound Effects, User Context\n- **Reuses:** 现有 SuccessOverlay，增强动画效果和数据展示\n\n### Backend Services\n\n#### 1. MissionService\n- **Purpose:** 任务管理业务逻辑，处理任务创建、执行、冷却等\n- **Interfaces:**\n  ```typescript\n  interface IMissionService {\n    getMissions(userId: string): Promise<Mission[]>;\n    completeMission(userId: string, missionId: string): Promise<RewardResult>;\n    checkCooldowns(userId: string): Promise<Mission[]>;\n  }\n  ```\n- **Dependencies:** Prisma Mission Model, User Service, Reward Calculator\n- **Reuses:** 现有 Mission Module，添加冷却机制和业务规则\n\n#### 2. UserStatsService\n- **Purpose:** 用户统计数据管理，处理等级、XP、成就等\n- **Interfaces:**\n  ```typescript\n  interface IUserStatsService {\n    getUserStats(userId: string): Promise<UserStats>;\n    updateUserStats(userId: string, updates: Partial<UserStats>): Promise<UserStats>;\n    checkLevelUp(stats: UserStats): Promise<boolean>;\n  }\n  ```\n- **Dependencies:** Prisma UserStats Model, Achievement Service\n- **Reuses:** 现有用户统计逻辑，扩展等级系统和成就检查\n\n#### 3. SyncService\n- **Purpose:** 数据同步服务，处理跨设备数据同步和离线支持\n- **Interfaces:**\n  ```typescript\n  interface ISyncService {\n    syncUserData(userId: string, lastSync?: Date): Promise<SyncResult>;\n    handleOfflineActions(userId: string, actions: OfflineAction[]): Promise<void>;\n  }\n  ```\n- **Dependencies:** UserStatsService, MissionService, Timestamp Management\n- **Reuses:** 新增服务，实现数据持久化和同步逻辑\n\n## Data Models\n\n### Enhanced Prisma Schema\n\n```prisma\n// 增强的任务模型\nmodel Mission {\n  id          String   @id @default(cuid())\n  title       Json     // { en: string, zh: string }\n  description Json     // { en: string, zh: string }\n  xpReward    Int\n  coinReward  Int\n  category    Category // FITNESS, LEARNING, PRODUCTIVITY\n  difficulty  Difficulty // EASY, MEDIUM, HARD\n  emoji       String\n  isDaily     Boolean  @default(false)\n  duration    Int?     // 计时任务时长（秒）\n  cooldownHours Int   @default(24) // 冷却时间（小时）\n  isActive    Boolean  @default(true)\n  createdAt   DateTime @default(now())\n  updatedAt   DateTime @updatedAt\n\n  // 关联关系\n  userProgress UserProgress[]\n  userMissions UserMission[]\n}\n\n// 用户任务关联（用户自定义任务）\nmodel UserMission {\n  id        String   @id @default(cuid())\n  userId    String\n  missionId String\n  isCompleted Boolean @default(false)\n  completedAt DateTime?\n  streak    Int      @default(0)\n  lastCompleted DateTime?\n  createdAt DateTime @default(now())\n  updatedAt DateTime @updatedAt\n\n  mission Mission @relation(fields: [missionId], references: [id])\n  \n  @@unique([userId, missionId])\n}\n\n// 增强的用户统计\nmodel UserStats {\n  id                 String   @id @default(cuid())\n  userId             String   @unique\n  level              Int      @default(1)\n  currentXp          Int      @default(0)\n  maxXp              Int      @default(100)\n  coins              Int      @default(0)\n  totalMissionsCompleted Int   @default(0)\n  totalXpEarned      Int      @default(0)\n  currentStreak      Int      @default(0)\n  longestStreak      Int      @default(0)\n  rank               Rank     @default(CADET)\n  lastActive         DateTime @default(now())\n  avatar             String?  // 用户头像URL\n  preferredLang      String   @default(\"en\") // en, zh\n  settings           Json?    // 用户设置\n  createdAt          DateTime @default(now())\n  updatedAt          DateTime @updatedAt\n\n  // 关联关系\n  achievements UserAchievement[]\n  syncData     UserSync[]\n}\n\n// 数据同步记录\nmodel UserSync {\n  id         String   @id @default(cuid())\n  userId     String\n  lastSyncAt DateTime @default(now())\n  syncToken  String   @unique\n  deviceInfo Json?    // 设备信息\n  createdAt  DateTime @default(now())\n\n  userStats UserStats @relation(fields: [userId], references: [id], onDelete: Cascade)\n}\n\n// 更新的枚举定义\nenum Category {\n  BODY      // 机体健康类\n  BRAIN     // 脑力学习类  \n  BASE      // 基地家务类\n}\n\nenum Difficulty {\n  EASY\n  MEDIUM\n  HARD\n}\n\nenum Rank {\n  CADET      // 学员\n  LIEUTENANT // 中尉\n  CAPTAIN    // 舰长\n  COMMANDER  // 指挥官\n}\n```\n\n### tRPC 路由定义\n\n```typescript\n// 任务路由\nexport const missionRouter = t.router({\n  getMissions: t.procedure\n    .input(z.object({ category: z.enum(['BODY', 'BRAIN', 'BASE']).optional() }))\n    .query(({ input, ctx }) => missionService.getMissions(ctx.userId, input)),\n    \n  completeMission: t.procedure\n    .input(z.object({ missionId: z.string() }))\n    .mutation(({ input, ctx }) => missionService.completeMission(ctx.userId, input.missionId)),\n    \n  createMission: t.procedure\n    .input(z.object({\n      title: z.record(z.string()),\n      category: z.enum(['BODY', 'BRAIN', 'BASE']),\n      difficulty: z.enum(['EASY', 'MEDIUM', 'HARD']),\n      xpReward: z.number(),\n      coinReward: z.number(),\n      emoji: z.string(),\n      duration: z.number().optional(),\n      isDaily: z.boolean().default(false)\n    }))\n    .mutation(({ input, ctx }) => missionService.createMission(ctx.userId, input))\n});\n\n// 用户统计路由\nexport const userStatsRouter = t.router({\n  getStats: t.procedure\n    .query(({ ctx }) => userStatsService.getUserStats(ctx.userId)),\n    \n  updateSettings: t.procedure\n    .input(z.object({\n      preferredLang: z.enum(['en', 'zh']),\n      avatar: z.string().optional()\n    }))\n    .mutation(({ input, ctx }) => userStatsService.updateSettings(ctx.userId, input))\n});\n\n// 数据同步路由\nexport const syncRouter = t.router({\n  sync: t.procedure\n    .input(z.object({ lastSync: z.date().optional() }))\n    .query(({ input, ctx }) => syncService.syncUserData(ctx.userId, input.lastSync)),\n    \n  uploadOfflineActions: t.procedure\n    .input(z.object({ actions: z.array(z.any()) }))\n    .mutation(({ input, ctx }) => syncService.handleOfflineActions(ctx.userId, input.actions))\n});\n```\n\n## Error Handling\n\n### 错误场景和处理策略\n\n1. **任务执行失败**\n   - **场景**: 网络中断、任务不存在、冷却中\n   - **处理**: 本地缓存状态，网络恢复后自动同步\n   - **用户影响**: 显示\"同步中\"状态，允许继续使用应用\n\n2. **数据同步冲突**\n   - **场景**: 多设备同时操作导致数据冲突\n   - **处理**: 时间戳优先策略，保留最新操作记录\n   - **用户影响**: 透明处理，后台自动解决冲突\n\n3. **等级计算错误**\n   - **场景**: XP计算异常、等级边界条件\n   - **处理**: 服务端重新计算，客户端状态校正\n   - **用户影响**: 可能出现\"数据校正中\"提示\n\n4. **离线模式限制**\n   - **场景**: 长时间离线无法同步数据\n   - **处理**: 本地存储操作队列，限制离线时长\n   - **用户影响**: 提示网络连接，部分功能受限\n\n## Testing Strategy\n\n### 单元测试 (Unit Testing)\n- **核心组件测试**: HUD、MissionCard、RewardOverlay 等核心组件\n- **业务逻辑测试**: 任务完成、XP计算、等级提升逻辑\n- **工具函数测试**: 数据格式化、时间处理、状态计算\n- **覆盖率目标**: 核心业务逻辑 > 90%\n\n### 集成测试 (Integration Testing)\n- **API 集成测试**: tRPC 路由端到端测试\n- **数据库集成测试**: Prisma 操作和数据一致性\n- **组件集成测试**: 组件间数据流和状态管理\n- **同步功能测试**: 离线操作和在线同步流程\n\n### 端到端测试 (E2E Testing)\n- **用户场景测试**: \n  - 新用户注册和首次使用流程\n  - 任务执行和奖励获取完整流程\n  - 多设备数据同步验证\n  - 等级提升和成就解锁体验\n- **性能测试**: \n  - 大量任务数据下的响应时间\n  - 动画效果的流畅性测试\n  - 内存使用和泄漏检测\n\n### 测试工具链\n- **前端**: Jest + React Testing Library + Cypress\n- **后端**: Jest + Supertest + Prisma Test Environment  \n- **类型检查**: TypeScript strict 模式 + ESLint\n- **性能测试**: Lighthouse + Web Vitals monitoring",
  "fileStats": {
    "size": 13935,
    "lines": 427,
    "lastModified": "2025-12-22T09:13:13.621Z"
  },
  "comments": []
}