{
  "id": "snapshot_1766397129328_lv015az3b",
  "approvalId": "approval_1766397035976_q18olpu8y",
  "approvalTitle": "Starship Commander 后端适配设计文档 (修订版)",
  "version": 2,
  "timestamp": "2025-12-22T09:52:09.328Z",
  "trigger": "approved",
  "status": "pending",
  "content": "# Design Document - Starship Commander Core (Backend Focus)\n\n## Overview\n\n基于现有前端代码（React + TypeScript），本设计专注于后端架构适配和数据模式设计，确保后端 API 与前端组件完美对接。现有前端已实现舰桥控制台、任务卡片、结算弹窗等核心 UI 组件，需要构建对应的后端服务来支持这些功能。\n\n设计重点：**后端 API 适配** + **数据模型设计** + **类型安全集成**，而非前端 UI 重新设计。\n\n## Steering Document Alignment\n\n### Technical Standards\n- **全栈 TypeScript**: 确保类型安全和开发体验一致性\n- **模块化架构**: 遵循 NestJS 的模块化设计模式\n- **tRPC 类型安全**: 前后端 API 调用完全类型安全\n- **React 19**: 利用最新的 React 特性和性能优化\n- **Prisma ORM**: 类型安全的数据库访问和迁移\n\n### Project Structure\n```\nsrc/\n├── frontend/          # React 前端应用\n│   ├── components/    # 可复用 UI 组件\n│   ├── contexts/      # React Context 状态管理\n│   ├── hooks/         # 自定义 React Hooks\n│   ├── services/      # API 服务层\n│   └── types/         # TypeScript 类型定义\n├── backend/           # NestJS 后端应用\n│   ├── modules/       # 业务模块\n│   ├── services/      # 业务服务\n│   ├── utils/         # 工具函数\n│   └── trpc/          # tRPC 路由和配置\n└── shared/            # 共享类型和工具\n    ├── types/         # 共享类型定义\n    └── constants/     # 共享常量\n```\n\n## Frontend Analysis & Backend Requirements\n\n### 现有前端组件分析\n基于对现有前端代码的分析，需要以下后端支持：\n\n#### 前端已实现的核心组件\n1. **HUD Component**: \n   - 显示用户等级、XP 进度条、CR 硬币\n   - 需要后端提供用户统计数据接口\n\n2. **MissionCard Component**: \n   - 显示任务信息、执行按钮、完成状态\n   - 需要后端提供任务列表、任务执行、冷却状态管理\n\n3. **SuccessOverlay Component**: \n   - 显示任务完成奖励动画\n   - 需要后端计算并返回 XP 和 CR 奖励\n\n4. **App.tsx 主组件**: \n   - 管理全局状态（missions, stats, historyLog）\n   - 需要后端支持数据持久化和同步\n\n### Backend API Requirements\n\n#### 前端现有数据结构适配\n```typescript\n// 前端 Mission 类型 (需要后端支持)\ninterface Mission {\n  id: string;\n  title: { en: string, zh: string };\n  description: { en: string, zh: string };\n  xpReward: number;\n  coinReward: number;\n  isCompleted: boolean;\n  category: MissionCategory; // BODY | BRAIN | BASE\n  emoji: string;\n  isDaily: boolean;\n  streak: number;\n}\n\n// 前端 UserStats 类型 (需要后端支持)\ninterface UserStats {\n  level: number;\n  currentXp: number;\n  maxXp: number;\n  coins: number;\n  totalMissionsCompleted: number;\n  totalXpEarned: number;\n  rank: string;\n}\n```\n\n#### 必需的后端 API 接口\n1. **用户数据获取**: GET /trpc/user.getStats\n2. **任务列表获取**: GET /trpc/mission.getMissions  \n3. **任务执行**: POST /trpc/mission.completeMission\n4. **任务创建**: POST /trpc/mission.createMission (用户自定义)\n5. **历史记录**: GET /trpc/user.getHistory\n6. **数据同步**: POST /trpc/sync.upload\n\n## Architecture\n\n### 整体架构设计\n\n```mermaid\ngraph TB\n    subgraph \"Frontend (React 19)\"\n        A[HUD Dashboard] --> B[Mission System]\n        B --> C[Reward System]\n        C --> D[User Profile]\n        E[Language Context] --> A\n        E --> B\n        E --> C\n        E --> D\n    end\n    \n    subgraph \"API Layer (tRPC)\"\n        F[tRPC Router] --> G[Mission Router]\n        F --> H[User Stats Router]\n        F --> I[Achievement Router]\n        F --> J[Sync Router]\n    end\n    \n    subgraph \"Backend (NestJS)\"\n        G --> K[Mission Service]\n        H --> L[User Service]\n        I --> M[Achievement Service]\n        J --> N[Sync Service]\n    end\n    \n    subgraph \"Data Layer\"\n        K --> O[Prisma ORM]\n        L --> O\n        M --> O\n        N --> O\n        O --> P[SQLite Database]\n    end\n    \n    A -.-> F\n    B -.-> G\n    C -.-> H\n    D -.-> I\n```\n\n### 模块化设计原则\n\n#### 前端模块化\n- **单一文件职责**: 每个组件文件专注于单一功能领域\n- **组件隔离**: 创建小型、专注的组件而非大型单体文件\n- **服务层分离**: 分离数据访问、业务逻辑和表现层\n- **工具模块化**: 将工具函数分解为专注的单一目的模块\n\n#### 后端模块化\n- **模块独立性**: 每个业务模块独立，具有清晰的边界\n- **依赖注入**: 使用 NestJS 的 DI 容器管理依赖关系\n- **接口抽象**: 定义清晰的接口契约，便于测试和维护\n- **错误处理**: 统一的错误处理和响应格式\n\n## Backend Services & API Design\n\n### 核心 tRPC 路由设计\n\n#### 1. UserStats Service\n- **Purpose:** 用户统计数据管理，支持前端 HUD 组件数据需求\n- **API 接口:**\n  ```typescript\n  export const userRouter = t.router({\n    getStats: t.procedure\n      .query(async ({ ctx }) => {\n        // 返回用户等级、XP、CR 等数据\n        return await userStatsService.getUserStats(ctx.userId);\n      }),\n      \n    updateStats: t.procedure\n      .input(z.object({\n        xp: z.number().optional(),\n        coins: z.number().optional(),\n        level: z.number().optional()\n      }))\n      .mutation(async ({ input, ctx }) => {\n        // 更新用户统计数据\n        return await userStatsService.updateUserStats(ctx.userId, input);\n      }),\n      \n    getHistory: t.procedure\n      .input(z.object({\n        limit: z.number().default(20),\n        offset: z.number().default(0)\n      }))\n      .query(async ({ input, ctx }) => {\n        // 获取任务历史记录\n        return await userStatsService.getMissionHistory(ctx.userId, input);\n      })\n  });\n  ```\n\n#### 2. Mission Service  \n- **Purpose:** 任务管理，支持前端 MissionCard 组件的完整生命周期\n- **API 接口:**\n  ```typescript\n  export const missionRouter = t.router({\n    getMissions: t.procedure\n      .input(z.object({\n        category: z.enum(['BODY', 'BRAIN', 'BASE']).optional(),\n        isCompleted: z.boolean().optional()\n      }))\n      .query(async ({ input, ctx }) => {\n        // 返回任务列表，支持分类筛选\n        return await missionService.getMissions(ctx.userId, input);\n      }),\n      \n    completeMission: t.procedure\n      .input(z.object({ missionId: z.string() }))\n      .mutation(async ({ input, ctx }) => {\n        // 执行任务完成逻辑，返回奖励数据\n        return await missionService.completeMission(ctx.userId, input.missionId);\n      }),\n      \n    createMission: t.procedure\n      .input(z.object({\n        title: z.record(z.string()),\n        description: z.record(z.string()),\n        category: z.enum(['BODY', 'BRAIN', 'BASE']),\n        xpReward: z.number(),\n        coinReward: z.number(),\n        emoji: z.string(),\n        isDaily: z.boolean()\n      }))\n      .mutation(async ({ input, ctx }) => {\n        // 创建用户自定义任务\n        return await missionService.createMission(ctx.userId, input);\n      })\n  });\n  ```\n\n#### 3. Sync Service\n- **Purpose:** 数据同步，支持离线使用和多设备同步\n- **API 接口:**\n  ```typescript\n  export const syncRouter = t.router({\n    syncData: t.procedure\n      .input(z.object({\n        lastSyncAt: z.date().optional()\n      }))\n      .query(async ({ input, ctx }) => {\n        // 返回需要同步的数据\n        return await syncService.getSyncData(ctx.userId, input.lastSyncAt);\n      }),\n      \n    uploadOfflineActions: t.procedure\n      .input(z.object({\n        actions: z.array(z.object({\n          type: z.string(),\n          data: z.any(),\n          timestamp: z.date()\n        }))\n      }))\n      .mutation(async ({ input, ctx }) => {\n        // 处理离线操作同步\n        return await syncService.processOfflineActions(ctx.userId, input.actions);\n      })\n  });\n  ```\n\n### Backend Services\n\n#### 1. MissionService\n- **Purpose:** 任务管理业务逻辑，处理任务创建、执行、冷却等\n- **Interfaces:**\n  ```typescript\n  interface IMissionService {\n    getMissions(userId: string): Promise<Mission[]>;\n    completeMission(userId: string, missionId: string): Promise<RewardResult>;\n    checkCooldowns(userId: string): Promise<Mission[]>;\n  }\n  ```\n- **Dependencies:** Prisma Mission Model, User Service, Reward Calculator\n- **Reuses:** 现有 Mission Module，添加冷却机制和业务规则\n\n#### 2. UserStatsService\n- **Purpose:** 用户统计数据管理，处理等级、XP、成就等\n- **Interfaces:**\n  ```typescript\n  interface IUserStatsService {\n    getUserStats(userId: string): Promise<UserStats>;\n    updateUserStats(userId: string, updates: Partial<UserStats>): Promise<UserStats>;\n    checkLevelUp(stats: UserStats): Promise<boolean>;\n  }\n  ```\n- **Dependencies:** Prisma UserStats Model, Achievement Service\n- **Reuses:** 现有用户统计逻辑，扩展等级系统和成就检查\n\n#### 3. SyncService\n- **Purpose:** 数据同步服务，处理跨设备数据同步和离线支持\n- **Interfaces:**\n  ```typescript\n  interface ISyncService {\n    syncUserData(userId: string, lastSync?: Date): Promise<SyncResult>;\n    handleOfflineActions(userId: string, actions: OfflineAction[]): Promise<void>;\n  }\n  ```\n- **Dependencies:** UserStatsService, MissionService, Timestamp Management\n- **Reuses:** 新增服务，实现数据持久化和同步逻辑\n\n## Data Models - 适配前端需求\n\n### Prisma Schema 设计（基于前端数据结构）\n\n```prisma\n// 任务模型 - 完全适配前端 Mission 接口\nmodel Mission {\n  id          String   @id @default(cuid())\n  title       Json     // {\"en\": \"Brush Teeth\", \"zh\": \"刷牙\"}\n  description Json     // {\"en\": \"Keep your teeth healthy\", \"zh\": \"保持牙齿健康\"}\n  xpReward    Int\n  coinReward  Int\n  category    Category // BODY | BRAIN | BASE (对应前端枚举)\n  emoji       String   // 任务图标\n  isDaily     Boolean  @default(false)\n  streak      Int      @default(0) // 连续完成天数\n  isActive    Boolean  @default(true)\n  createdAt   DateTime @default(now())\n  updatedAt   DateTime @updatedAt\n\n  // 用户任务关联\n  userMissions UserMission[]\n}\n\n// 用户任务关联表 - 支持任务完成状态\nmodel UserMission {\n  id           String    @id @default(cuid())\n  userId       String\n  missionId    String\n  isCompleted  Boolean   @default(false)\n  completedAt  DateTime?\n  streak       Int       @default(0)\n  lastCompleted DateTime?\n  cooldownUntil DateTime? // 冷却结束时间\n  createdAt    DateTime  @default(now())\n  updatedAt    DateTime  @updatedAt\n\n  mission Mission @relation(fields: [missionId], references: [id])\n  \n  @@unique([userId, missionId])\n}\n\n// 用户统计数据 - 完全适配前端 UserStats 接口\nmodel UserStats {\n  id                      String   @id @default(cuid())\n  userId                  String   @unique\n  level                   Int      @default(1)\n  currentXp               Int      @default(0)\n  maxXp                   Int      @default(100)\n  coins                   Int      @default(0)\n  totalMissionsCompleted  Int      @default(0)\n  totalXpEarned           Int      @default(0)\n  currentStreak           Int      @default(0)\n  longestStreak           Int      @default(0)\n  rank                    Rank     @default(CADET) // 对应前端 rank 字段\n  lastActive              DateTime @default(now())\n  preferredLang           String   @default(\"en\") // en | zh\n  createdAt               DateTime @default(now())\n  updatedAt               DateTime @updatedAt\n\n  // 关联关系\n  missionHistory MissionHistory[]\n}\n\n// 任务历史记录 - 支持 CaptainsLog 组件\nmodel MissionHistory {\n  id            String   @id @default(cuid())\n  userId        String\n  missionId     String\n  missionTitle  Json     // 任务标题快照（支持多语言）\n  xpEarned      Int\n  coinEarned    Int\n  category      Category\n  timestamp     DateTime @default(now())\n\n  userStats     UserStats @relation(fields: [userId], references: [id])\n}\n\n// 枚举定义 - 完全匹配前端\nenum Category {\n  BODY    // 机体健康类\n  BRAIN   // 脑力学习类\n  BASE    // 基地家务类\n}\n\nenum Rank {\n  CADET      // 学员\n  LIEUTENANT // 中尉  \n  CAPTAIN    // 舰长\n  COMMANDER  // 指挥官\n}\n```\n\n### 类型同步 - 前后端共享类型\n\n```typescript\n// src/shared/types.ts - 前后端共享\nexport interface Mission {\n  id: string;\n  title: LocalizedString;\n  description: LocalizedString;\n  xpReward: number;\n  coinReward: number;\n  isCompleted: boolean;\n  category: Category;\n  emoji: string;\n  isDaily: boolean;\n  streak: number;\n}\n\nexport interface UserStats {\n  level: number;\n  currentXp: number;\n  maxXp: number;\n  coins: number;\n  totalMissionsCompleted: number;\n  totalXpEarned: number;\n  rank: string;\n}\n\nexport interface LocalizedString {\n  en: string;\n  zh: string;\n}\n\nexport type Category = 'BODY' | 'BRAIN' | 'BASE';\n```\n\n### tRPC 路由定义\n\n```typescript\n// 任务路由\nexport const missionRouter = t.router({\n  getMissions: t.procedure\n    .input(z.object({ category: z.enum(['BODY', 'BRAIN', 'BASE']).optional() }))\n    .query(({ input, ctx }) => missionService.getMissions(ctx.userId, input)),\n    \n  completeMission: t.procedure\n    .input(z.object({ missionId: z.string() }))\n    .mutation(({ input, ctx }) => missionService.completeMission(ctx.userId, input.missionId)),\n    \n  createMission: t.procedure\n    .input(z.object({\n      title: z.record(z.string()),\n      category: z.enum(['BODY', 'BRAIN', 'BASE']),\n      difficulty: z.enum(['EASY', 'MEDIUM', 'HARD']),\n      xpReward: z.number(),\n      coinReward: z.number(),\n      emoji: z.string(),\n      duration: z.number().optional(),\n      isDaily: z.boolean().default(false)\n    }))\n    .mutation(({ input, ctx }) => missionService.createMission(ctx.userId, input))\n});\n\n// 用户统计路由\nexport const userStatsRouter = t.router({\n  getStats: t.procedure\n    .query(({ ctx }) => userStatsService.getUserStats(ctx.userId)),\n    \n  updateSettings: t.procedure\n    .input(z.object({\n      preferredLang: z.enum(['en', 'zh']),\n      avatar: z.string().optional()\n    }))\n    .mutation(({ input, ctx }) => userStatsService.updateSettings(ctx.userId, input))\n});\n\n// 数据同步路由\nexport const syncRouter = t.router({\n  sync: t.procedure\n    .input(z.object({ lastSync: z.date().optional() }))\n    .query(({ input, ctx }) => syncService.syncUserData(ctx.userId, input.lastSync)),\n    \n  uploadOfflineActions: t.procedure\n    .input(z.object({ actions: z.array(z.any()) }))\n    .mutation(({ input, ctx }) => syncService.handleOfflineActions(ctx.userId, input.actions))\n});\n```\n\n## Error Handling\n\n### 错误场景和处理策略\n\n1. **任务执行失败**\n   - **场景**: 网络中断、任务不存在、冷却中\n   - **处理**: 本地缓存状态，网络恢复后自动同步\n   - **用户影响**: 显示\"同步中\"状态，允许继续使用应用\n\n2. **数据同步冲突**\n   - **场景**: 多设备同时操作导致数据冲突\n   - **处理**: 时间戳优先策略，保留最新操作记录\n   - **用户影响**: 透明处理，后台自动解决冲突\n\n3. **等级计算错误**\n   - **场景**: XP计算异常、等级边界条件\n   - **处理**: 服务端重新计算，客户端状态校正\n   - **用户影响**: 可能出现\"数据校正中\"提示\n\n4. **离线模式限制**\n   - **场景**: 长时间离线无法同步数据\n   - **处理**: 本地存储操作队列，限制离线时长\n   - **用户影响**: 提示网络连接，部分功能受限\n\n## Testing Strategy\n\n### 单元测试 (Unit Testing)\n- **核心组件测试**: HUD、MissionCard、RewardOverlay 等核心组件\n- **业务逻辑测试**: 任务完成、XP计算、等级提升逻辑\n- **工具函数测试**: 数据格式化、时间处理、状态计算\n- **覆盖率目标**: 核心业务逻辑 > 90%\n\n### 集成测试 (Integration Testing)\n- **API 集成测试**: tRPC 路由端到端测试\n- **数据库集成测试**: Prisma 操作和数据一致性\n- **组件集成测试**: 组件间数据流和状态管理\n- **同步功能测试**: 离线操作和在线同步流程\n\n### 端到端测试 (E2E Testing)\n- **用户场景测试**: \n  - 新用户注册和首次使用流程\n  - 任务执行和奖励获取完整流程\n  - 多设备数据同步验证\n  - 等级提升和成就解锁体验\n- **性能测试**: \n  - 大量任务数据下的响应时间\n  - 动画效果的流畅性测试\n  - 内存使用和泄漏检测\n\n### 测试工具链\n- **前端**: Jest + React Testing Library + Cypress\n- **后端**: Jest + Supertest + Prisma Test Environment  \n- **类型检查**: TypeScript strict 模式 + ESLint\n- **性能测试**: Lighthouse + Web Vitals monitoring",
  "fileStats": {
    "size": 16872,
    "lines": 534,
    "lastModified": "2025-12-22T09:50:31.998Z"
  },
  "comments": []
}