# å…¬ç½‘äº‘æœåŠ¡å™¨éƒ¨ç½²é…ç½®ï¼ˆæ”¹è¿›ç‰ˆï¼‰/ Public Cloud Deployment Configuration (Improved)
#
# ä½¿ç”¨æ–¹æ³• / Usage:
# 1. è®¾ç½®ç¯å¢ƒå˜é‡ / Set environment variables:
#    export PUBLIC_IP="your.server.ip"  # ä½ çš„å…¬ç½‘ IP / Your public IP
#    export JWT_SECRET="$(openssl rand -base64 32)"  # ç”Ÿæˆéšæœºå¯†é’¥ / Generate random secret
#    export DOMAIN="yourdomain.com"  # å¯é€‰ï¼šåŸŸå / Optional: Domain name
#
# 2. é¦–æ¬¡éƒ¨ç½²ï¼ˆåˆå§‹åŒ–æ•°æ®åº“ï¼‰/ First deployment (init database):
#    docker-compose -f docker-compose.cloud.yml --profile init up -d
#
# 3. åç»­éƒ¨ç½²ï¼ˆä¸åŒ…å«æ•°æ®åº“åˆå§‹åŒ–ï¼‰/ Subsequent deployments (without db init):
#    docker-compose -f docker-compose.cloud.yml up -d
#
# 4. æŸ¥çœ‹æ—¥å¿— / View logs:
#    docker-compose -f docker-compose.cloud.yml logs -f
#
# 5. åœæ­¢æœåŠ¡ / Stop services:
#    docker-compose -f docker-compose.cloud.yml down

services:
  # ==========================================
  # åç«¯æœåŠ¡ / Backend Service
  # ==========================================
  backend:
    build:
      context: .
      dockerfile: Dockerfile.backend
      target: runner
    container_name: starship-backend
    restart: unless-stopped
    user: "0:0"  # ğŸ”§ ä½¿ç”¨ root ç”¨æˆ·è¿è¡Œä»¥ä¿®å¤æ•°æ®åº“æƒé™é—®é¢˜ / Use root to fix database permissions
    ports:
      - "3001:3001"
    environment:
      - NODE_ENV=production
      - PORT=3001
      # å‰ç«¯ URLï¼ˆä½¿ç”¨åŸŸåæˆ– IPï¼‰/ Frontend URL (domain or IP)
      - FRONTEND_URL=http://${DOMAIN:-${PUBLIC_IP:-YOUR_PUBLIC_IP}}:3000
      - DATABASE_URL=file:/app/prisma/dev.db
      # âš ï¸ å¿…é¡»è®¾ç½®å¼ºéšæœºå¯†é’¥ / Must set strong random secret
      - JWT_SECRET=${JWT_SECRET:-change-this-to-random-string-in-production}
      - JWT_EXPIRES_IN=7d
      - LOG_LEVEL=info
      # CORS é…ç½®ï¼ˆç§»é™¤ localhostï¼‰/ CORS config (remove localhost)
      - CORS_ORIGINS=http://${DOMAIN:-${PUBLIC_IP:-YOUR_PUBLIC_IP}}:3000,https://${DOMAIN:-${PUBLIC_IP:-YOUR_PUBLIC_IP}}:3000
    volumes:
      - starship-db:/app/prisma
      - starship-logs:/app/logs
    networks:
      - starship-network
    healthcheck:
      test: ["CMD", "node", "-e", "require('http').get('http://localhost:3001/trpc/health', (r) => {process.exit(r.statusCode === 200 ? 0 : 1)})"]
      interval: 30s
      timeout: 3s
      retries: 3
      start_period: 40s
    # èµ„æºé™åˆ¶ / Resource limits
    deploy:
      resources:
        limits:
          cpus: '1'
          memory: 1G
        reservations:
          cpus: '0.5'
          memory: 512M

  # ==========================================
  # å‰ç«¯æœåŠ¡ / Frontend Service
  # ==========================================
  frontend:
    build:
      context: .
      dockerfile: Dockerfile.frontend
      target: runner
      args:
        # å‰ç«¯è¿æ¥åç«¯çš„å…¬ç½‘åœ°å€ / Frontend connects to backend via public address
        - VITE_API_URL=http://${DOMAIN:-${PUBLIC_IP:-YOUR_PUBLIC_IP}}:3001/trpc
    container_name: starship-frontend
    restart: unless-stopped
    ports:
      - "3000:3000"
    networks:
      - starship-network
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:3000/"]
      interval: 30s
      timeout: 3s
      retries: 3
      start_period: 10s
    depends_on:
      backend:
        condition: service_healthy
    deploy:
      resources:
        limits:
          cpus: '0.5'
          memory: 256M
        reservations:
          cpus: '0.25'
          memory: 128M

  # ==========================================
  # æ•°æ®åº“åˆå§‹åŒ–æœåŠ¡ï¼ˆä»…é¦–æ¬¡ï¼‰/ Database Init Service (First time only)
  # ==========================================
  db-init:
    build:
      context: .
      dockerfile: Dockerfile.backend
      target: builder
    container_name: starship-db-init
    user: "0:0"  # ä½¿ç”¨ root ç”¨æˆ· / Use root
    environment:
      - NODE_ENV=production
      - DATABASE_URL=file:/app/prisma/dev.db
    volumes:
      - starship-db:/app/prisma
    networks:
      - starship-network
    command: >
      sh -c "
        if [ ! -f /app/prisma/dev.db ]; then
          echo 'ğŸ”§ Initializing database...';
          pnpm prisma:push &&
          pnpm prisma:seed &&
          echo 'âœ… Database initialized successfully';
        else
          echo 'â„¹ï¸  Database already exists, skipping initialization';
        fi
      "
    profiles:
      - init  # ä½¿ç”¨ --profile init æ¥è¿è¡Œæ­¤æœåŠ¡ / Use --profile init to run this service

networks:
  starship-network:
    driver: bridge

volumes:
  starship-db:
    driver: local
  starship-logs:
    driver: local
