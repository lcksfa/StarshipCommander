# æ–°å»ºä»»åŠ¡åŠŸèƒ½ä¿®å¤è¦ç‚¹

> **QAè¯„ä¼°æŠ¥å‘Š** - æäº¤: `9d95ec0`
> **è¯„ä¼°æ—¥æœŸ**: 2025-12-23
> **åŠŸèƒ½**: æ–°å»ºä»»åŠ¡åŠŸèƒ½ï¼ˆMission Creationï¼‰
> **æ€»ä½“å†³ç­–**: âš ï¸ **CONDITIONAL PASS (å¸¦æ¡ä»¶é€šè¿‡)**

---

## ğŸ“‹ ç›®å½•

- [æ‰§è¡Œæ‘˜è¦](#æ‰§è¡Œæ‘˜è¦)
- [é—®é¢˜æ¦‚è¿°](#é—®é¢˜æ¦‚è¿°)
- [ä¿®å¤ä¼˜å…ˆçº§çŸ©é˜µ](#ä¿®å¤ä¼˜å…ˆçº§çŸ©é˜µ)
- [è¯¦ç»†ä¿®å¤æ–¹æ¡ˆ](#è¯¦ç»†ä¿®å¤æ–¹æ¡ˆ)
- [æµ‹è¯•å»ºè®®](#æµ‹è¯•å»ºè®®)
- [å®æ–½è®¡åˆ’](#å®æ–½è®¡åˆ’)

---

## ğŸ¯ æ‰§è¡Œæ‘˜è¦

### å½“å‰çŠ¶æ€

| ç»´åº¦ | è¯„åˆ† | çŠ¶æ€ |
|------|------|------|
| åŠŸèƒ½å®Œæ•´æ€§ | 8/10 | âœ… æ ¸å¿ƒåŠŸèƒ½å·²å®ç° |
| æ•°æ®éªŒè¯ | 6/10 | âš ï¸ éœ€è¦å¢å¼º |
| é”™è¯¯å¤„ç† | 4/10 | âŒ ä»…æ§åˆ¶å°æ—¥å¿— |
| å®‰å…¨æ€§ | 3/10 | âŒ æ— èº«ä»½éªŒè¯ |
| å¯æµ‹è¯•æ€§ | 9/10 | âœ… ä»£ç ç»“æ„æ¸…æ™° |
| **æ€»ä½“è¯„åˆ†** | **6.0/10** | âš ï¸ **éœ€è¦æ”¹è¿›** |

### å…³é”®å‘ç°

**âœ… ä¼˜ç‚¹**ï¼š
- æ ¸å¿ƒåŠŸèƒ½æ­£å¸¸å·¥ä½œ
- TypeScriptç±»å‹å®‰å…¨
- ä»£ç ç»“æ„æ¸…æ™°
- åŸºç¡€è¾“å…¥éªŒè¯åˆ°ä½

**âŒ ç¼ºé™·**ï¼š
- ç¼ºå°‘èº«ä»½éªŒè¯å’Œæˆæƒ
- é”™è¯¯å¤„ç†ä¸è¶³ï¼ˆç”¨æˆ·æ— åé¦ˆï¼‰
- ç¼ºå°‘ä¸šåŠ¡è§„åˆ™éªŒè¯
- æ— æµ‹è¯•è¦†ç›–

### ç”Ÿäº§å°±ç»ªåº¦

**å½“å‰çŠ¶æ€**: âš ï¸ **éœ€è¦æ”¹è¿›åæ‰èƒ½éƒ¨ç½²åˆ°ç”Ÿäº§ç¯å¢ƒ**

---

## ğŸ“Š é—®é¢˜æ¦‚è¿°

### å·²ä¿®å¤çš„é—®é¢˜

âœ… **é—®é¢˜1**: å‰ç«¯æœªè°ƒç”¨åç«¯API
- **çŠ¶æ€**: å·²ä¿®å¤
- **è§£å†³æ–¹æ¡ˆ**: åœ¨ `App.tsx` ä¸­å®ç° `handleAddMission` APIè°ƒç”¨

âœ… **é—®é¢˜2**: åç«¯ç¼ºå°‘ `createMission` ç«¯ç‚¹
- **çŠ¶æ€**: å·²ä¿®å¤
- **è§£å†³æ–¹æ¡ˆ**: åœ¨ `main.ts` ä¸­æ·»åŠ  tRPC ç«¯ç‚¹

### å¾…ä¿®å¤çš„é—®é¢˜

âŒ **é—®é¢˜3**: æ— èº«ä»½éªŒè¯ (P0 - é˜»å¡)
âŒ **é—®é¢˜4**: é”™è¯¯å¤„ç†ä¸è¶³ (P0 - é˜»å¡)
âš ï¸ **é—®é¢˜5**: ä¸šåŠ¡è§„åˆ™éªŒè¯ç¼ºå¤± (P1)
âš ï¸ **é—®é¢˜6**: æµ‹è¯•è¦†ç›–ä¸è¶³ (P1)

---

## ğŸ”¥ ä¿®å¤ä¼˜å…ˆçº§çŸ©é˜µ

### P0 - å¿…é¡»ä¿®å¤ (é˜»å¡å‘å¸ƒ)

| é—®é¢˜ | å½±å“ | å·¥ä½œé‡ | é£é™© |
|------|------|--------|------|
| 1. æ·»åŠ èº«ä»½éªŒè¯ä¸­é—´ä»¶ | å®‰å…¨æ€§ | 4å°æ—¶ | ğŸ”´ é«˜ |
| 2. æ”¹è¿›é”™è¯¯å¤„ç†å’Œç”¨æˆ·åé¦ˆ | ç”¨æˆ·ä½“éªŒ | 2å°æ—¶ | ğŸŸ¡ ä¸­ |

**æ€»è®¡**: 6å°æ—¶

### P1 - åº”è¯¥ä¿®å¤ (ä¸‹ä¸ªè¿­ä»£)

| é—®é¢˜ | å½±å“ | å·¥ä½œé‡ | é£é™© |
|------|------|--------|------|
| 3. å¢å¼ºè¾“å…¥éªŒè¯ï¼ˆä¸šåŠ¡è§„åˆ™ï¼‰ | æ•°æ®è´¨é‡ | 3å°æ—¶ | ğŸŸ¡ ä¸­ |
| 4. æ·»åŠ å•å…ƒæµ‹è¯• | è´¨é‡ä¿è¯ | 4å°æ—¶ | ğŸŸ¡ ä¸­ |
| 5. æ·»åŠ E2Eæµ‹è¯• | è´¨é‡ä¿è¯ | 2å°æ—¶ | ğŸŸ¢ ä½ |

**æ€»è®¡**: 9å°æ—¶

### P2 - å¯ä»¥æ”¹è¿› (æŒç»­ä¼˜åŒ–)

| é—®é¢˜ | å½±å“ | å·¥ä½œé‡ | é£é™© |
|------|------|--------|------|
| 6. ç§»é™¤ `any` ç±»å‹ | ç±»å‹å®‰å…¨ | 30åˆ†é’Ÿ | ğŸŸ¢ ä½ |
| 7. æ·»åŠ æ€§èƒ½ç›‘æ§ | è¿ç»´ | 2å°æ—¶ | ğŸŸ¢ ä½ |
| 8. å®ç°å®¡è®¡æ—¥å¿— | åˆè§„æ€§ | 3å°æ—¶ | ğŸŸ¢ ä½ |

**æ€»è®¡**: 5.5å°æ—¶

**æ€»å·¥ä½œé‡ä¼°ç®—**: **20.5å°æ—¶**

---

## ğŸ”§ è¯¦ç»†ä¿®å¤æ–¹æ¡ˆ

## P0-1: æ·»åŠ èº«ä»½éªŒè¯ä¸­é—´ä»¶

### é—®é¢˜åˆ†æ

**ä½ç½®**: [src/backend/main.ts:116-129](../src/backend/main.ts#L116-L129)

```typescript
createMission: procedure
  .input(schemas.createMission)
  .mutation(async ({ input }) => {
    // âŒ æ— èº«ä»½éªŒè¯æ£€æŸ¥
    const mission = await missionService.createMission(input);
    return { success: true, data: mission };
  }),
```

**é£é™©**: ä»»ä½•ç”¨æˆ·éƒ½å¯ä»¥åˆ›å»ºä»»åŠ¡ï¼Œæ— æ³•è¿½è¸ªåˆ›å»ºè€…ï¼Œå­˜åœ¨æ•°æ®æ»¥ç”¨é£é™©ã€‚

### è§£å†³æ–¹æ¡ˆ

#### æ­¥éª¤1: åˆ›å»ºèº«ä»½éªŒè¯ä¸Šä¸‹æ–‡

```typescript
// src/backend/context.ts
import { CreateExpressContextOptions } from "@trpc/server/adapters/express";
import { IncomingMessage } from "http";

interface User {
  id: string;
  email: string;
  role: string;
}

export async function createContext({
  req,
  res,
}: CreateExpressContextOptions) {
  // ä»è¯·æ±‚å¤´æˆ–cookieä¸­è·å–ç”¨æˆ·ä¿¡æ¯
  const user = await getUserFromRequest(req);

  return {
    req,
    res,
    user,
  };
}

async function getUserFromRequest(req: IncomingMessage): Promise<User | null> {
  // TODO: å®ç°JWTéªŒè¯æˆ–sessionéªŒè¯
  // ä¸´æ—¶æ–¹æ¡ˆï¼šä»è‡ªå®šä¹‰headerè·å–
  const userId = req.headers["x-user-id"] as string;

  if (!userId) {
    return null;
  }

  // éªŒè¯ç”¨æˆ·æ˜¯å¦å­˜åœ¨
  // const user = await prisma.userStats.findUnique({
  //   where: { userId }
  // });

  return {
    id: userId,
    email: `${userId}@example.com`,
    role: "user",
  };
}

export type Context = Awaited<ReturnType<typeof createContext>>;
```

#### æ­¥éª¤2: åˆ›å»ºå—ä¿æŠ¤çš„è¿‡ç¨‹

```typescript
// src/backend/main.ts
import type { Context } from "./context.js";
import { TRPCError } from "@trpc/server";

// åˆ›å»ºä¸Šä¸‹æ–‡
const createContext = async ({
  req,
  res,
}: CreateExpressContextOptions) => {
  const user = await getUserFromRequest(req);
  return { req, res, user };
};

// åˆ›å»ºå—ä¿æŠ¤çš„procedureï¼ˆéœ€è¦èº«ä»½éªŒè¯ï¼‰
const protectedProcedure = t.procedure.use(async ({ ctx, next }) => {
  if (!ctx.user) {
    throw new TRPCError({
      code: "UNAUTHORIZED",
      message: "You must be logged in to create missions",
    });
  }
  return next({
    ctx: {
      ...ctx,
      user: ctx.user, // TypeScriptç°åœ¨çŸ¥é“userå­˜åœ¨
    },
  });
});

// ä½¿ç”¨å—ä¿æŠ¤çš„procedure
missions: router({
  createMission: protectedProcedure
    .input(schemas.createMission)
    .mutation(async ({ input, ctx }) => {
      // ctx.userç°åœ¨ä¿è¯å­˜åœ¨
      const mission = await missionService.createMission({
        ...input,
        createdBy: ctx.user.id, // è¿½è¸ªåˆ›å»ºè€…
      });

      return {
        success: true,
        data: mission,
        message: "Mission created successfully",
      };
    }),
  // ... å…¶ä»–ç«¯ç‚¹
})
```

#### æ­¥éª¤3: æ›´æ–°ä¸Šä¸‹æ–‡ç±»å‹

```typescript
// åˆ›å»ºå¸¦ç±»å‹çš„ä¸Šä¸‹æ–‡
interface Context {
  req: IncomingMessage;
  res: OutgoingMessage;
  user?: User;
}

// åˆ›å»ºtRPCå®ä¾‹
const t = initTRPC.context<Context>().create();
```

### éªŒè¯æ­¥éª¤

1. âœ… æœªç™»å½•ç”¨æˆ·å°è¯•åˆ›å»ºä»»åŠ¡ â†’ è¿”å› 401 é”™è¯¯
2. âœ… å·²ç™»å½•ç”¨æˆ·åˆ›å»ºä»»åŠ¡ â†’ ä»»åŠ¡æˆåŠŸåˆ›å»ºï¼Œå¹¶è®°å½•åˆ›å»ºè€…
3. âœ… æµ‹è¯•ä¸Šä¸‹æ–‡ä¸­çš„ç”¨æˆ·ä¿¡æ¯æ­£ç¡®ä¼ é€’

---

## P0-2: æ”¹è¿›é”™è¯¯å¤„ç†å’Œç”¨æˆ·åé¦ˆ

### é—®é¢˜åˆ†æ

**ä½ç½®**: [src/frontend/App.tsx:155-159](../src/frontend/App.tsx#L155-L159)

```typescript
} catch (error) {
  // âš ï¸ ä»…è®°å½•åˆ°æ§åˆ¶å°
  console.error("Failed to create mission:", error);
  // TODO: æ˜¾ç¤ºé”™è¯¯æç¤ºç»™ç”¨æˆ·
}
```

**é£é™©**: ç”¨æˆ·ä¸çŸ¥é“æ“ä½œå¤±è´¥ï¼Œå¯¼è‡´å›°æƒ‘å’Œé‡å¤å°è¯•ã€‚

### è§£å†³æ–¹æ¡ˆ

#### æ­¥éª¤1: å®‰è£…Toaståº“

```bash
pnpm add sonner
```

#### æ­¥éª¤2: åˆ›å»ºToastæä¾›è€…

```typescript
// src/frontend/App.tsx
import { Toaster } from "sonner";

function App() {
  return (
    <div>
      {/* å…¶ä»–ç»„ä»¶ */}

      {/* æ·»åŠ Toastç»„ä»¶ */}
      <Toaster
        position="top-right"
        richColors
        closeButton
        duration={4000}
      />
    </div>
  );
}
```

#### æ­¥éª¤3: æ›´æ–°é”™è¯¯å¤„ç†

```typescript
// src/frontend/App.tsx
import { toast } from "sonner";
import { getErrorMessage } from "./utils/error-utils";

const handleAddMission = async (missionData: MissionData) => {
  try {
    // æ˜¾ç¤ºåŠ è½½æç¤º
    const loadingToast = toast.loading("æ­£åœ¨åˆ›å»ºä»»åŠ¡...");

    await apiClient.createMission({
      title: missionData.title,
      description: `ä¼˜å…ˆçº§: ${missionData.difficulty.toUpperCase()}`,
      xpReward: missionData.xp,
      coinReward: missionData.coins,
      category: missionData.category,
      emoji: missionData.emoji,
      isDaily: missionData.isDaily,
      difficulty: missionData.difficulty.toUpperCase() as "EASY" | "MEDIUM" | "HARD",
    });

    // æˆåŠŸæç¤º
    toast.success("ä»»åŠ¡åˆ›å»ºæˆåŠŸï¼", {
      id: loadingToast,
      description: `"${missionData.title}" å·²æ·»åŠ åˆ°æ‚¨çš„ä»»åŠ¡åˆ—è¡¨`,
    });

    setIsModalOpen(false);
    await refetchMissions();

  } catch (error) {
    // é”™è¯¯æç¤º
    const errorMessage = getErrorMessage(error);

    toast.error("ä»»åŠ¡åˆ›å»ºå¤±è´¥", {
      description: errorMessage,
      action: {
        label: "é‡è¯•",
        onClick: () => handleAddMission(missionData),
      },
    });

    // åŒæ—¶è®°å½•åˆ°æ§åˆ¶å°
    console.error("Failed to create mission:", error);

    // TODO: å‘é€åˆ°é”™è¯¯è¿½è¸ªæœåŠ¡ï¼ˆå¦‚Sentryï¼‰
    // logErrorToService('createMission', error, { missionData });
  }
};
```

#### æ­¥éª¤4: åˆ›å»ºé”™è¯¯å·¥å…·å‡½æ•°

```typescript
// src/frontend/utils/error-utils.ts
export function getErrorMessage(error: unknown): string {
  if (error instanceof Error) {
    return error.message;
  }

  if (typeof error === "string") {
    return error;
  }

  if (error && typeof error === "object" && "message" in error) {
    return String(error.message);
  }

  return "æœªçŸ¥é”™è¯¯ï¼Œè¯·ç¨åé‡è¯•";
}

export function isNetworkError(error: unknown): boolean {
  if (error instanceof Error) {
    return (
      error.message.includes("fetch") ||
      error.message.includes("network") ||
      error.message.includes("ECONNREFUSED")
    );
  }
  return false;
}
```

#### æ­¥éª¤5: åç«¯ç»Ÿä¸€é”™è¯¯æ ¼å¼

```typescript
// src/backend/main.ts
createMission: protectedProcedure
  .input(schemas.createMission)
  .mutation(async ({ input, ctx }) => {
    try {
      const mission = await missionService.createMission({
        ...input,
        createdBy: ctx.user.id,
      });

      return {
        success: true,
        data: mission,
        message: "Mission created successfully",
      };

    } catch (error) {
      // ç»Ÿä¸€é”™è¯¯å¤„ç†
      if (error instanceof Error) {
        throw new TRPCError({
          code: "BAD_REQUEST",
          message: error.message,
        });
      }

      throw new TRPCError({
        code: "INTERNAL_SERVER_ERROR",
        message: "An unexpected error occurred",
      });
    }
  }),
```

### éªŒè¯æ­¥éª¤

1. âœ… åˆ›å»ºæˆåŠŸ â†’ æ˜¾ç¤ºæˆåŠŸæç¤º
2. âœ… ç½‘ç»œé”™è¯¯ â†’ æ˜¾ç¤ºé”™è¯¯æç¤ºå’Œé‡è¯•æŒ‰é’®
3. âœ… éªŒè¯é”™è¯¯ â†’ æ˜¾ç¤ºå…·ä½“çš„éªŒè¯é”™è¯¯
4. âœ… æœåŠ¡å™¨é”™è¯¯ â†’ æ˜¾ç¤ºå‹å¥½çš„é”™è¯¯æ¶ˆæ¯

---

## P1-3: å¢å¼ºè¾“å…¥éªŒè¯ï¼ˆä¸šåŠ¡è§„åˆ™ï¼‰

### é—®é¢˜åˆ†æ

**ä½ç½®**: [src/backend/main.ts:63-72](../src/backend/main.ts#L63-L72)

```typescript
createMission: z.object({
  title: z.string().min(1),
  description: z.string().min(1),
  xpReward: z.number().min(0).max(1000),
  coinReward: z.number().min(0).max(500),
  emoji: z.string().min(1).max(10),
  // âŒ ç¼ºå°‘ï¼šXp/Coinsä¸éš¾åº¦åŒ¹é…æ£€æŸ¥
  // âŒ ç¼ºå°‘ï¼šé‡å¤ä»»åŠ¡æ£€æŸ¥
  difficulty: z.enum(["EASY", "MEDIUM", "HARD"]),
}),
```

**é£é™©**: ç”¨æˆ·å¯ä»¥åˆ›å»ºä¸åˆç†çš„æ•°æ®ï¼ˆå¦‚EASYä»»åŠ¡è®¾ç½®1000 XPï¼‰ã€‚

### è§£å†³æ–¹æ¡ˆ

#### æ­¥éª¤1: å®šä¹‰éš¾åº¦å¥–åŠ±é…ç½®

```typescript
// src/backend/config/mission-rules.ts
export const MISSION_DIFFICULTY_CONFIG = {
  EASY: {
    min: { xp: 10, coins: 5 },
    max: { xp: 50, coins: 25 },
    recommended: { xp: 25, coins: 10 },
  },
  MEDIUM: {
    min: { xp: 30, coins: 15 },
    max: { xp: 150, coins: 75 },
    recommended: { xp: 75, coins: 30 },
  },
  HARD: {
    min: { xp: 100, coins: 50 },
    max: { xp: 500, coins: 250 },
    recommended: { xp: 200, coins: 100 },
  },
} as const;

export type MissionDifficulty = keyof typeof MISSION_DIFFICULTY_CONFIG;
```

#### æ­¥éª¤2: åˆ›å»ºè‡ªå®šä¹‰éªŒè¯

```typescript
// src/backend/validation/mission-validation.ts
import { z } from "zod";
import { MISSION_DIFFICULTY_CONFIG } from "../config/mission-rules.js";

// éªŒè¯å¥–åŠ±ä¸éš¾åº¦åŒ¹é…
export const validateRewardsMatchDifficulty = (
  data: {
    difficulty: MissionDifficulty;
    xpReward: number;
    coinReward: number;
  }
) => {
  const config = MISSION_DIFFICULTY_CONFIG[data.difficulty];

  if (data.xpReward < config.min.xp || data.xpReward > config.max.xp) {
    return false;
  }

  if (data.coinReward < config.min.coins || data.coinReward > config.max.coins) {
    return false;
  }

  return true;
};

// éªŒè¯emojiï¼ˆå¯é€‰ï¼‰
export const validateEmoji = (emoji: string): boolean => {
  // ç®€å•æ£€æŸ¥ï¼šemojié€šå¸¸åœ¨ç‰¹å®šUnicodeèŒƒå›´
  const emojiRegex = /\p{Emoji}/u;
  return emojiRegex.test(emoji) && emoji.length <= 10;
};
```

#### æ­¥éª¤3: æ›´æ–°Zod Schema

```typescript
// src/backend/main.ts
import { validateRewardsMatchDifficulty } from "./validation/mission-validation.js";

const schemas = {
  createMission: z.object({
    title: z.string().min(1).max(100),
    description: z.string().min(1).max(500),
    xpReward: z.number().int().positive().max(1000),
    coinReward: z.number().int().positive().max(500),
    category: z.enum(["study", "health", "chore", "creative"]),
    emoji: z.string().min(1).max(10),
    isDaily: z.boolean(),
    difficulty: z.enum(["EASY", "MEDIUM", "HARD"]),
  })
  .refine(
    (data) => validateRewardsMatchDifficulty(data),
    {
      message: "å¥–åŠ±å¿…é¡»ä¸éš¾åº¦çº§åˆ«åŒ¹é…",
      path: ["xpReward", "coinReward"],
    }
  )
  .refine(
    (data) => data.title.trim().length > 0,
    {
      message: "ä»»åŠ¡æ ‡é¢˜ä¸èƒ½ä¸ºç©º",
      path: ["title"],
    }
  ),
};
```

#### æ­¥éª¤4: æ·»åŠ é‡å¤æ£€æŸ¥ï¼ˆå¯é€‰ï¼‰

```typescript
// src/backend/main.ts
createMission: protectedProcedure
  .input(schemas.createMission)
  .mutation(async ({ input, ctx }) => {
    try {
      // æ£€æŸ¥é‡å¤ä»»åŠ¡
      const existing = await missionService.findDuplicate({
        title: input.title,
        userId: ctx.user.id,
        isActive: true,
      });

      if (existing) {
        throw new TRPCError({
          code: "CONFLICT",
          message: "æ‚¨å·²ç»åˆ›å»ºäº†ä¸€ä¸ªç±»ä¼¼ä»»åŠ¡",
        });
      }

      // åˆ›å»ºä»»åŠ¡
      const mission = await missionService.createMission({
        ...input,
        createdBy: ctx.user.id,
      });

      return {
        success: true,
        data: mission,
        message: "Mission created successfully",
      };

    } catch (error) {
      // é”™è¯¯å¤„ç†...
    }
  }),
```

### éªŒè¯æ­¥éª¤

1. âœ… EASYä»»åŠ¡è®¾ç½®50 XP â†’ é€šè¿‡
2. âœ… EASYä»»åŠ¡è®¾ç½®100 XP â†’ æ‹’ç»ï¼Œæ˜¾ç¤ºé”™è¯¯
3. âœ… ç©ºæ ‡é¢˜ â†’ æ‹’ç»
4. âœ… é‡å¤æ ‡é¢˜ â†’ è­¦å‘Šæˆ–æ‹’ç»ï¼ˆæ ¹æ®ä¸šåŠ¡éœ€æ±‚ï¼‰

---

## P1-4 & P1-5: æ·»åŠ æµ‹è¯•è¦†ç›–

### å•å…ƒæµ‹è¯•

```typescript
// src/backend/services/__tests__/mission.service.test.ts
import { MissionService } from "../mission.service";
import { PrismaService } from "../../database/prisma.service";

describe("MissionService", () => {
  let service: MissionService;
  let prisma: PrismaService;

  beforeEach(() => {
    prisma = new PrismaService();
    service = new MissionService(prisma);
  });

  describe("createMission", () => {
    it("should create mission with valid input", async () => {
      const input = {
        title: "Test Mission",
        description: "Test Description",
        xpReward: 50,
        coinReward: 25,
        category: "study" as const,
        emoji: "ğŸ“š",
        isDaily: false,
        difficulty: "EASY" as const,
      };

      const result = await service.createMission(input);

      expect(result).toHaveProperty("id");
      expect(result.title).toBe(input.title);
      expect(result.xpReward).toBe(input.xpReward);
    });

    it("should reject invalid XP rewards", async () => {
      const input = {
        title: "Test",
        description: "Test",
        xpReward: 10000, // è¶…è¿‡æœ€å¤§å€¼
        coinReward: 25,
        category: "study" as const,
        emoji: "ğŸ“š",
        isDaily: false,
        difficulty: "EASY" as const,
      };

      await expect(service.createMission(input)).rejects.toThrow();
    });

    it("should handle database errors gracefully", async () => {
      // Mock prisma error
      jest.spyOn(prisma.mission, "create").mockRejectedValue(
        new Error("Database connection failed")
      );

      const input = {
        title: "Test",
        description: "Test",
        xpReward: 50,
        coinReward: 25,
        category: "study" as const,
        emoji: "ğŸ“š",
        isDaily: false,
        difficulty: "EASY" as const,
      };

      await expect(service.createMission(input)).rejects.toThrow(
        "Database connection failed"
      );
    });
  });
});
```

### é›†æˆæµ‹è¯•

```typescript
// tests/integration/mission-creation.test.ts
import { test, expect } from "@playwright/test";

test.describe("Mission Creation Flow", () => {
  test.beforeEach(async ({ page }) => {
    await page.goto("http://localhost:5173");
    await page.waitForLoadState("networkidle");
  });

  test("should create mission successfully", async ({ page }) => {
    // 1. ç‚¹å‡»æ–°å»ºæŒ‰é’®
    await page.click('[data-testid="add-mission-button"]');

    // 2. å¡«å†™è¡¨å•
    await page.fill('[data-testid="mission-title"]', "å­¦ä¹ ç¼–ç¨‹");
    await page.click('[data-testid="category-study"]');
    await page.click('[data-testid="difficulty-medium"]');

    // 3. æäº¤
    await page.click('[data-testid="submit-mission"]');

    // 4. éªŒè¯
    await expect(page.locator('text=/ä»»åŠ¡åˆ›å»ºæˆåŠŸ/')).toBeVisible();
    await expect(page.locator('text=/å­¦ä¹ ç¼–ç¨‹/')).toBeVisible();
  });

  test("should show error on validation failure", async ({ page }) => {
    await page.click('[data-testid="add-mission-button"]');

    // ä¸å¡«å†™æ ‡é¢˜ï¼Œç›´æ¥æäº¤
    await page.click('[data-testid="submit-mission"]');

    // éªŒè¯é”™è¯¯æç¤º
    await expect(page.locator('text=/è¯·è¾“å…¥ä»»åŠ¡æ ‡é¢˜/')).toBeVisible();
  });

  test("should retry on network error", async ({ page }) => {
    // Mockç½‘ç»œé”™è¯¯
    await page.route("**/trpc/missions.createMission", route => {
      route.abort();
    });

    await page.click('[data-testid="add-mission-button"]');
    await page.fill('[data-testid="mission-title"]', "æµ‹è¯•ä»»åŠ¡");
    await page.click('[data-testid="submit-mission"]');

    // éªŒè¯é”™è¯¯æç¤º
    await expect(page.locator('text=/ç½‘ç»œé”™è¯¯/')).toBeVisible();
    await expect(page.locator('text=/é‡è¯•/')).toBeVisible();
  });
});
```

### è¿è¡Œæµ‹è¯•

```bash
# å•å…ƒæµ‹è¯•
pnpm test mission.service.test

# E2Eæµ‹è¯•
pnpm test:e2e:playwright mission-creation.test.ts

# è¦†ç›–ç‡æŠ¥å‘Š
pnpm test:cov
```

---

## ğŸ“… å®æ–½è®¡åˆ’

### ç¬¬ä¸€å‘¨ (P0é—®é¢˜)

| ä»»åŠ¡ | é¢„è®¡æ—¶é—´ | è´Ÿè´£äºº | ä¾èµ– |
|------|---------|--------|------|
| å®ç°èº«ä»½éªŒè¯ä¸Šä¸‹æ–‡ | 2å°æ—¶ | - | æ—  |
| åˆ›å»ºå—ä¿æŠ¤çš„procedure | 1å°æ—¶ | - | ä¸Šä¸‹æ–‡ |
| æ›´æ–°createMissionç«¯ç‚¹ | 1å°æ—¶ | - | procedure |
| å®‰è£…å’Œé…ç½®Toast | 30åˆ†é’Ÿ | - | æ—  |
| æ›´æ–°é”™è¯¯å¤„ç†é€»è¾‘ | 1å°æ—¶ | - | Toast |
| æµ‹è¯•å’ŒéªŒè¯ | 1å°æ—¶ | - | ä»¥ä¸Šæ‰€æœ‰ |
| **æ€»è®¡** | **6.5å°æ—¶** | | |

**é‡Œç¨‹ç¢‘**: P0é—®é¢˜ä¿®å¤å®Œæˆï¼ŒåŠŸèƒ½å¯ä»¥å®‰å…¨éƒ¨ç½²åˆ°æµ‹è¯•ç¯å¢ƒã€‚

### ç¬¬äºŒå‘¨ (P1é—®é¢˜)

| ä»»åŠ¡ | é¢„è®¡æ—¶é—´ | è´Ÿè´£äºº | ä¾èµ– |
|------|---------|--------|------|
| å®šä¹‰éš¾åº¦å¥–åŠ±é…ç½® | 30åˆ†é’Ÿ | - | æ—  |
| å®ç°ä¸šåŠ¡è§„åˆ™éªŒè¯ | 1.5å°æ—¶ | - | é…ç½® |
| ç¼–å†™å•å…ƒæµ‹è¯• | 3å°æ—¶ | - | æ—  |
| ç¼–å†™E2Eæµ‹è¯• | 2å°æ—¶ | - | æ—  |
| æµ‹è¯•è¦†ç›–ç‡éªŒè¯ | 1å°æ—¶ | - | æµ‹è¯• |
| **æ€»è®¡** | **8å°æ—¶** | | |

**é‡Œç¨‹ç¢‘**: P1é—®é¢˜ä¿®å¤å®Œæˆï¼Œä»£ç è´¨é‡æ˜¾è‘—æå‡ã€‚

### æŒç»­ä¼˜åŒ– (P2é—®é¢˜)

| ä»»åŠ¡ | é¢„è®¡æ—¶é—´ | è´Ÿè´£äºº | ä¼˜å…ˆçº§ |
|------|---------|--------|--------|
| ç§»é™¤anyç±»å‹ | 30åˆ†é’Ÿ | - | ä½ |
| æ·»åŠ æ€§èƒ½ç›‘æ§ | 2å°æ—¶ | - | ä½ |
| å®ç°å®¡è®¡æ—¥å¿— | 3å°æ—¶ | - | ä½ |
| **æ€»è®¡** | **5.5å°æ—¶** | | |

**é‡Œç¨‹ç¢‘**: ä»£ç è´¨é‡å’Œå¯ç»´æŠ¤æ€§æŒç»­æ”¹è¿›ã€‚

---

## ğŸ“Š æˆåŠŸæŒ‡æ ‡

### æŠ€æœ¯æŒ‡æ ‡

| æŒ‡æ ‡ | å½“å‰å€¼ | ç›®æ ‡å€¼ | æµ‹é‡æ–¹æ³• |
|------|--------|--------|----------|
| æµ‹è¯•è¦†ç›–ç‡ | 0% | 80% | `pnpm test:cov` |
| TypeScriptä¸¥æ ¼æ¨¡å¼ | 70% | 100% | `pnpm typecheck` |
| ESLinté”™è¯¯ | 2ä¸ª | 0ä¸ª | `pnpm lint` |
| å®‰å…¨æ¼æ´ | 1ä¸ªé«˜å± | 0ä¸ª | å®‰å…¨å®¡è®¡ |

### ç”¨æˆ·ä½“éªŒæŒ‡æ ‡

| æŒ‡æ ‡ | å½“å‰å€¼ | ç›®æ ‡å€¼ | æµ‹é‡æ–¹æ³• |
|------|--------|--------|----------|
| ä»»åŠ¡åˆ›å»ºæˆåŠŸç‡ | ~80% | 99%+ | é”™è¯¯è¿½è¸ª |
| é”™è¯¯åé¦ˆåŠæ—¶æ€§ | 0ç§’ | <1ç§’ | ç”¨æˆ·åé¦ˆ |
| ç”¨æˆ·æ»¡æ„åº¦ | æœªçŸ¥ | 4.5/5 | ç”¨æˆ·è°ƒç ” |

---

## ğŸ”„ æŒç»­æ”¹è¿›

### ç›‘æ§è¦ç‚¹

1. **é”™è¯¯ç‡ç›‘æ§**
   ```typescript
   // é›†æˆé”™è¯¯è¿½è¸ªï¼ˆå¦‚Sentryï¼‰
   import * as Sentry from "@sentry/browser";

   Sentry.init({
     dsn: process.env.SENTRY_DSN,
     environment: process.env.NODE_ENV,
   });
   ```

2. **æ€§èƒ½ç›‘æ§**
   ```typescript
   // è®°å½•APIå“åº”æ—¶é—´
   console.time('createMission');
   await apiClient.createMission(data);
   console.timeEnd('createMission');
   ```

3. **ç”¨æˆ·è¡Œä¸ºåˆ†æ**
   - è®°å½•ä»»åŠ¡åˆ›å»ºé¢‘ç‡
   - åˆ†ææœ€å¸¸è§çš„ä»»åŠ¡ç±»åˆ«
   - è¯†åˆ«å¤±è´¥æ¨¡å¼

### åé¦ˆå¾ªç¯

1. **æ¯æ—¥**: æ£€æŸ¥é”™è¯¯æ—¥å¿—
2. **æ¯å‘¨**: å®¡æŸ¥ç”¨æˆ·åé¦ˆ
3. **æ¯æœˆ**: è¯„ä¼°å’Œè°ƒæ•´ä¼˜å…ˆçº§

---

## ğŸ“š å‚è€ƒèµ„æ–™

### ç›¸å…³æ–‡æ¡£

- [é¡¹ç›®æ¶æ„æ–‡æ¡£](./PROJECT_STRUCTURE.md)
- [å¼€å‘è§„èŒƒ](../CLAUDE.md)
- [tRPCæ–‡æ¡£](https://trpc.io/docs/)
- [ZodéªŒè¯](https://zod.dev/)
- [Playwrightæµ‹è¯•](https://playwright.dev/)

### ä»£ç ç¤ºä¾‹

- èº«ä»½éªŒè¯æ¨¡å¼: `src/backend/context.ts`
- é”™è¯¯å¤„ç†å·¥å…·: `src/frontend/utils/error-utils.ts`
- ä¸šåŠ¡è§„åˆ™é…ç½®: `src/backend/config/mission-rules.ts`

---

## âœ… æ£€æŸ¥æ¸…å•

### å‘å¸ƒå‰æ£€æŸ¥

- [ ] æ‰€æœ‰P0é—®é¢˜å·²ä¿®å¤
- [ ] èº«ä»½éªŒè¯å·²å®ç°
- [ ] é”™è¯¯å¤„ç†å·²æ”¹è¿›
- [ ] åŸºç¡€æµ‹è¯•å·²æ·»åŠ 
- [ ] ä»£ç å®¡æŸ¥é€šè¿‡
- [ ] æ–‡æ¡£å·²æ›´æ–°

### éƒ¨ç½²åæ£€æŸ¥

- [ ] ç›‘æ§é”™è¯¯ç‡
- [ ] æ”¶é›†ç”¨æˆ·åé¦ˆ
- [ ] éªŒè¯æ€§èƒ½æŒ‡æ ‡
- [ ] æ£€æŸ¥å®‰å…¨æ—¥å¿—

---

**æ–‡æ¡£ç‰ˆæœ¬**: 1.0.0
**æœ€åæ›´æ–°**: 2025-12-23
**ç»´æŠ¤è€…**: QA Team
