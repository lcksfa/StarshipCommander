// Prisma Schema for Starship Commander
// Starship Commander 数据库模式定义

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
  url      = env("DATABASE_URL")
}

// 任务模型 / Mission Model
model Mission {
  id          String   @id @default(cuid())
  title       String   // JSON string: {en: "...", zh: "..."}
  description String   // JSON string: {en: "...", zh: "..."}
  xpReward    Int
  coinReward  Int
  category    Category
  emoji       String
  isDaily     Boolean  @default(false)
  difficulty  Difficulty
  isActive    Boolean  @default(true)

  userMissions  UserMission[]
  userProgress  UserProgress[]
  missionHistory MissionHistory[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("missions")
}

// 用户模型 / User Model
model User {
  id            String    @id @default(cuid())
  email         String    @unique
  username      String?   @unique
  passwordHash  String    // bcrypt hash

  // Profile information / 个人信息
  displayName   String?
  avatar        String?
  preferredLang  Language  @default(zh)

  // Account status / 账户状态
  isActive      Boolean   @default(true)
  isVerified    Boolean   @default(false)

  // Timestamps / 时间戳
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
  lastLoginAt    DateTime?

  // Relations / 关系
  stats         UserStats?  @relation("UserStats")
  sessions      Session[]

  @@map("users")
}

// 会话模型 / Session Model
model Session {
  id            String   @id @default(cuid())
  userId        String

  // Token information / Token 信息
  token         String   @unique
  refreshToken  String?  @unique

  // Device and location info / 设备和位置信息
  userAgent     String?
  ipAddress     String?

  // Expiration / 过期时间
  expiresAt     DateTime

  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  // Relations / 关系
  user          User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([token])
  @@map("sessions")
}

// 用户统计模型 / User Stats Model
model UserStats {
  id                    String   @id @default(cuid())
  userId                String   @unique

  // 偏好设置 / Preferences
  preferredLang         Language @default(zh)

  // 等级系统 / Level System
  level                Int      @default(1)
  currentXp            Int      @default(0)
  maxXp                Int      @default(100)

  // 货币系统 / Currency System
  coins                Int      @default(0)

  // 任务统计 / Mission Statistics
  totalMissionsCompleted Int     @default(0)
  totalXpEarned          Int     @default(0)

  // 连击系统 / Streak System
  currentStreak        Int      @default(0)
  longestStreak        Int      @default(0)
  lastActive           DateTime?

  achievements         UserAchievement[]
  missionHistory       MissionHistory[]

  // NEW: Add relation to User / 新增：关联到 User
  user                 User     @relation("UserStats", fields: [userId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("user_stats")
}

// 用户任务关联模型 / User Mission Relationship Model
model UserMission {
  id             String    @id @default(cuid())
  userId         String
  missionId      String

  isCompleted    Boolean   @default(false)
  completedAt    DateTime?
  streak         Int       @default(0)
  lastCompleted  DateTime?
  cooldownUntil  DateTime?

  mission        Mission   @relation(fields: [missionId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([userId, missionId])
  @@map("user_missions")
}

// 用户任务进度模型 / User Mission Progress Model
model UserProgress {
  id              String   @id @default(cuid())
  userId          String
  missionId       String

  progress        Int      @default(0)        // 0-100
  stepsCompleted  Int      @default(0)
  totalSteps      Int      @default(1)

  mission         Mission  @relation(fields: [missionId], references: [id], onDelete: Cascade)

  startedAt       DateTime @default(now())
  lastUpdatedAt   DateTime @updatedAt

  @@unique([userId, missionId])
  @@map("user_progress")
}

// 任务历史模型 / Mission History Model
model MissionHistory {
  id           String     @id @default(cuid())
  userStatsId  String     // 外键：引用 UserStats 的主键 / Foreign key to UserStats primary key
  userId       String     // 冗余字段：方便查询 / Redundant field for convenience
  missionId    String

  xpEarned     Int
  coinEarned   Int
  completedAt  DateTime   @default(now())

  mission      Mission    @relation(fields: [missionId], references: [id], onDelete: Cascade)
  userStats    UserStats  @relation(fields: [userStatsId], references: [id], onDelete: Cascade)

  @@map("mission_history")
}

// 成就模型 / Achievement Model
model Achievement {
  id          String             @id @default(cuid())
  title       String             // JSON string: {en: "...", zh: "..."}
  description String             // JSON string: {en: "...", zh: "..."}
  icon        String
  condition   String             // JSON string: {type: "...", target: ...}
  rarity      Rarity             @default(COMMON)
  isHidden    Boolean            @default(false)

  userAchievements UserAchievement[]

  createdAt DateTime @default(now())

  @@map("achievements")
}

// 用户成就模型 / User Achievement Model
model UserAchievement {
  id             String      @id @default(cuid())
  userStatsId    String      // 外键：引用 UserStats 的主键 / Foreign key to UserStats primary key
  userId         String      // 冗余字段：方便查询 / Redundant field for convenience
  achievementId  String

  unlockedAt     DateTime    @default(now())
  progress       String      // JSON string: {...}

  achievement    Achievement @relation(fields: [achievementId], references: [id], onDelete: Cascade)
  userStats      UserStats   @relation(fields: [userStatsId], references: [id], onDelete: Cascade)

  @@unique([userStatsId, achievementId])
  @@map("user_achievements")
}

// 枚举类型 / Enum Types

enum Category {
  STUDY
  HEALTH
  CHORE
  CREATIVE
}

enum Difficulty {
  EASY
  MEDIUM
  HARD
}

enum Language {
  en
  zh
}

enum Rarity {
  COMMON
  RARE
  EPIC
  LEGENDARY
}
